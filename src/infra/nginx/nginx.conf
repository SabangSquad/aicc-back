# aicc-back/infra/nginx/nginx.conf
user  nginx;
worker_processes auto;

events { worker_connections 2048; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout 65;
  server_tokens off;

  gzip on;
  gzip_types text/plain text/css application/javascript application/json image/svg+xml;

  # CORS 허용 오리진
  # 항목 추가/수정: 서비스 도메인
  map $http_origin $allowed_origin {
    default "";
    "http://localhost:3000"                 $http_origin;
    "https://aicc-web.duckdns.org"         $http_origin;
    "https://aicc-web.vercel.app"    $http_origin;
    # "~^https://.*\.vercel\.app$"            $http_origin;
  }

  # 업스트림 (백엔드)
  upstream backend {
    server aicc-api:4000;      # docker-compose 서비스명:포트
    keepalive 16;
  }

  # HTTP (80): 인증서 발급/갱신 + 443 리다이렉트
  server {
    listen 80;
    server_name aicc-web.duckdns.org;

    # certbot http-01 challenge 경로 (컨테이너 볼륨: infra/certbot/www)
    location /.well-known/acme-challenge/ {
      root /var/www/certbot;
    }

    # 인증서 발급 전엔 주석 처리
    # return 301 https://$host$request_uri;
  }

  # HTTPS (443): 프론트/백엔드 프록시 + CORS 
  server {
    listen 443 ssl http2;
    server_name aicc-web.duckdns.org;

    # certbot 발급 후에만 존재하는 파일들 (infra/letsencrypt 마운트)
    # ssl_certificate     /etc/letsencrypt/live/devridge6.duckdns.org/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/devridge6.duckdns.org/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 보안 헤더
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # 헬스체크
    location = /health {
      add_header Content-Type text/plain;
      return 200 "ok\n";
    }

    # /api: 백엔드 프록시 + 프리플라이트 처리 + CORS
    location ^~ /api/ {
      # Preflight (OPTIONS) 빠른 응답
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin $allowed_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
        add_header Access-Control-Max-Age 86400 always;
        return 204;
      }

      # API 프록시
      proxy_pass http://backend;
      proxy_http_version 1.1;
      proxy_set_header Connection "upgrade";
      proxy_set_header Upgrade $http_upgrade;

      # 원본 식별
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # CORS 응답 헤더
      add_header Access-Control-Allow-Origin $allowed_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Expose-Headers "Content-Length,Content-Type,Date,ETag" always;
    }

    # 루트: Vercel 프론트로 프록시
    location / {
      proxy_set_header Host aicc-web.vercel.app;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass https://aicc-web.vercel.app;
    }
  }
}