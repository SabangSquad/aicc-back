name: CD Pipeline

on:
  workflow_run:
    workflows: [ "CI Pipeline - Merge" ]
    types: [ completed ]

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            if [ -n "${{ secrets.REGISTRY_USER }}" ] && [ -n "${{ secrets.REGISTRY_TOKEN }}" ]; then
              echo "${{ secrets.REGISTRY_TOKEN }}" | docker login -u "${{ secrets.REGISTRY_USER }}" --password-stdin
            fi
            
            export ENV_FILE="/srv/aicc-back/.env"
            export HOST_INFRA_DIR="/srv/aicc-back/src/infra"

            sudo mkdir -p /srv/aicc-back/src/infra/nginx
            sudo mkdir -p /srv/aicc-back/src/infra/certbot/www
            sudo mkdir -p /srv/aicc-back/src/infra/letsencrypt
            sudo chown -R $USER:$USER /srv/aicc-back/src/infra


            # 배포
            docker compose -f /srv/aicc-back/docker-compose.yml pull
            docker compose -f /srv/aicc-back/docker-compose.yml up -d

            # Nginx 문법 검사 & 헬스체크
            docker exec aicc-nginx nginx -t || true
            curl -sSI http://127.0.0.1/health || true
            curl -sSI http://127.0.0.1/.well-known/acme-challenge/ping.txt || true
            docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'